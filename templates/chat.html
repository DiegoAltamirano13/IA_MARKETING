<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ALMAssist Chatbot</title>
    <!-- React y ReactDOM desde CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel para JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Iconos -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}" />
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      // Componente principal de la aplicación
      const { useState, useEffect, useRef } = React;

      const App = () => {
        const initialMessage = {
          id: 1,
          text: '¡Hola! Soy ALMAssist, tu asistente virtual. ¿En qué puedo ayudarte hoy?',
          sender: 'bot',
          timestamp: new Date().toLocaleTimeString(),
        };

        const [messages, setMessages] = useState([initialMessage]);
        const [inputText, setInputText] = useState('');
        const [isLoading, setIsLoading] = useState(false);
        const messagesEndRef = useRef(null);
        const inputRef = useRef(null);

        // Preguntas rápidas sugeridas
        const quickReplies = [
          '¿Dónde se encuentran?',
          'Ubicaciones en Querétaro',
          'Mostrar todas las ubicaciones',
          '¿Cómo puedo contactarlos?',
        ];

        // Efecto para hacer scroll al final de los mensajes
        useEffect(() => {
          scrollToBottom();
        }, [messages]);

        // Función para hacer scroll al final
        const scrollToBottom = () => {
          messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
        };

        const clearChat = async () => {
          const result = await Swal.fire({
            title: '¿Eliminar conversación?',
            text: 'Esta acción no se puede deshacer. Se perderá todo el historial del chat.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: '<i class="fas fa-trash"></i> Sí, eliminar',
            cancelButtonText: '<i class="fas fa-times"></i> Cancelar',
            reverseButtons: true,
          });

          if (result.isConfirmed) {
            setMessages([initialMessage]);

            // Confirmación de eliminación exitosa
            Swal.fire({
              title: '¡Eliminado!',
              text: 'La conversación ha sido eliminada correctamente.',
              icon: 'success',
              timer: 2000,
              showConfirmButton: false,
            });
          }
        };

        // Función para mostrar información con SweetAlert2
        const showInfo = () => {
          Swal.fire({
            title: '<strong>ALMAssist - Información</strong>',
            icon: 'info',
            html: `
              <div style="text-align: left;">
                <p><strong>ALMAssist Chatbot</strong></p>
                <p>Asistente virtual inteligente para ARGO Almacenadora</p>
                <br>
                <p><strong>Desarrollado por:</strong></p>
                <p>Diego Altamirano Suarez</p>
                <br>
                <p><strong>Aviso de Privacidad:</strong></p>
                <p>La información proporcionada por este chatbot está basada en inteligencia artificial y puede contener imprecisiones. Para información oficial y precisa, contacte directamente con ARGO Almacenadora.</p>
                <br>
                <p><strong>Derechos Reservados © 2024</strong></p>
                <p>ALMAssist - Todos los derechos reservados</p>
              </div>
            `,
            showCloseButton: true,
            showCancelButton: false,
            focusConfirm: false,
            confirmButtonText: '<i class="fa fa-thumbs-up"></i> Entendido',
            confirmButtonAriaLabel: 'Entendido',
            width: '600px',
          });
        };

        // Función para enviar mensaje
        const sendMessage = async () => {
          if (!inputText.trim() || isLoading) return;

          const userMessage = {
            id: messages.length + 1,
            text: inputText,
            sender: 'user',
            timestamp: new Date().toLocaleTimeString(),
          };

          setMessages((prevMessages) => [...prevMessages, userMessage]);
          setInputText('');
          setIsLoading(true);

          try {
            const response = await fetch('/chat', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({ message: inputText }),
            });

            const data = await response.json();

            const botMessage = {
              id: messages.length + 2,
              text: data.response || 'Lo siento, no pude procesar tu solicitud.',
              sender: 'bot',
              timestamp: new Date().toLocaleTimeString(),
            };

            setMessages((prevMessages) => [...prevMessages, botMessage]);
          } catch (error) {
            console.error('Error:', error);
            const errorMessage = {
              id: messages.length + 2,
              text: 'Lo siento, hubo un error al procesar tu mensaje. Por favor, intenta de nuevo.',
              sender: 'bot',
              timestamp: new Date().toLocaleTimeString(),
            };
            setMessages((prevMessages) => [...prevMessages, errorMessage]);
          } finally {
            setIsLoading(false);
          }
        };

        // Función para manejar el envío con la tecla Enter
        const handleKeyPress = (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        };

        // Función para usar una respuesta rápida
        const useQuickReply = (text) => {
          setInputText(text);
          inputRef.current.focus();
        };

        return (
          <div className='app-container'>
            <div className='sidebar'>
              <div className='logo'>
                <i className='logo-icon fas fa-robot'></i>
                <h2>ALMAssist</h2>
              </div>
              <div className='conversation-list'>
                <div className='conversation-item active'>
                  <i className='fas fa-comment'></i> Conversación
                </div>
              </div>
              <div className='settings'>
                <button onClick={showInfo}>
                  <i className='fas fa-info-circle'></i> Información
                </button>
              </div>
            </div>

            <div className='chat-container'>
              <div className='chat-header'>
                <div className='chat-title'>Asistente ALMAssist</div>
                <div className='chat-actions'>
                  <button title='Borrar conversación' onClick={clearChat}>
                    <i className='fas fa-trash'></i>
                  </button>
                  <button title='Información' onClick={showInfo}>
                    <i className='fas fa-info-circle'></i>
                  </button>
                </div>
              </div>

              <div className='messages-container'>
                {messages.map((message) => (
                  <div key={message.id} className={`message ${message.sender}`}>
                    <div className='message-content'>{message.text}</div>
                    <div className='timestamp'>{message.timestamp}</div>
                  </div>
                ))}

                {isLoading && (
                  <div className='message-typing'>
                    <div className='typing-dot'></div>
                    <div className='typing-dot'></div>
                    <div className='typing-dot'></div>
                  </div>
                )}

                <div ref={messagesEndRef} />
              </div>

              <div className='quick-replies'>
                {quickReplies.map((reply, index) => (
                  <button key={index} className='quick-reply' onClick={() => useQuickReply(reply)}>
                    {reply}
                  </button>
                ))}
              </div>

              <div className='input-container'>
                <input
                  type='text'
                  className='message-input'
                  placeholder='Escribe tu mensaje aquí...'
                  value={inputText}
                  onChange={(e) => setInputText(e.target.value)}
                  onKeyPress={handleKeyPress}
                  disabled={isLoading}
                  ref={inputRef}
                />
                <button
                  className='send-button'
                  onClick={sendMessage}
                  disabled={isLoading || !inputText.trim()}
                  title='Enviar mensaje'
                >
                  <i className='fas fa-paper-plane'></i>
                </button>
              </div>
              {/* LEYENDA IA AÑADIDA */}
              <div className='ia-disclaimer'>
                🤖 Asistente IA - Puede contener imprecisiones. Para información oficial contacte
                con ARGO Almacenadora.
              </div>
            </div>
          </div>
        );
      };

      // Renderizar la aplicación
      // CORREGIDO: Usar createRoot en lugar de ReactDOM.render
      const container = document.getElementById('root');
      const root = ReactDOM.createRoot(container);
      root.render(<App />);
    </script>
  </body>
</html>
